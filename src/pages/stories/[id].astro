---
import Layout from '../../layouts/Layout.astro';
import { getAllStories, getStoryById, type Story } from '../../lib/stories';
import DesktopStoryReader from '../../components/story/desktop/DesktopStoryReader.astro';
import MobileStoryReader from '../../components/story/mobile/MobileStoryReader.astro';

export async function getStaticPaths() {
  const stories = await getAllStories();
  return stories.map((story: Story) => ({
    params: { id: story.id }
  }));
}

const { id } = Astro.params;
const story = await getStoryById(id!);

if (!story) {
  return Astro.redirect('/404');
}

// 构建故事页面的 OG 数据
const storyTitle = `${story.config.title} - 若兰的AI故事书集锦`;
const storyDescription = story.config.description || story.config.pages[0] || '一个精彩的故事...';
const storyImageUrl = `${Astro.url.origin}${story.images.cover}`;
const storyUrl = `${Astro.url.origin}/stories/${story.id}`;

---

<Layout 
  title={storyTitle}
  description={storyDescription}
  ogImage={storyImageUrl}
  ogUrl={storyUrl}
  ogType="article"
>
  <div id="story-container">
    <!-- 默认显示桌面版，通过客户端JS切换 -->
    <div id="desktop-reader">
      <DesktopStoryReader story={story} />
    </div>
    <div id="mobile-reader" style="display: none;">
      <MobileStoryReader story={story} />
    </div>
  </div>
</Layout>

<script>
  import { isMobile } from '../../lib/device';
  
  // 在客户端检测设备类型
  const isMobileDevice = isMobile();
  const desktopReader = document.getElementById('desktop-reader');
  const mobileReader = document.getElementById('mobile-reader');
  
  if (isMobileDevice) {
    if (desktopReader) desktopReader.style.display = 'none';
    if (mobileReader) mobileReader.style.display = 'block';
  } else {
    if (desktopReader) desktopReader.style.display = 'block';
    if (mobileReader) mobileReader.style.display = 'none';
  }
</script>
